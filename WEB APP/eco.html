<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EcoSphere Monitoring Kit — Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase (v8 CDN for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    :root{
      --bg:#0f1724; --card:#0b2433; --accent:#2dd4bf; --muted:#94a3b8;
      --danger:#ff6b6b; --good:#7ee787;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{ margin:0; background:linear-gradient(180deg,#071128 0%, #082034 100%); color:#e6eef5; }
    .container{ max-width:1100px; margin:28px auto; padding:16px; }
    header{ display:flex; align-items:center; gap:12px; margin-bottom:18px; }
    h1{ margin:0; font-size:20px; letter-spacing:0.2px; }
    .grid{ display:grid; grid-template-columns: 1fr 360px; gap:16px; }
    .card{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
           border:1px solid rgba(255,255,255,0.04);
           padding:14px; border-radius:10px; box-shadow: 0 6px 18px rgba(2,6,23,0.6);}
    .metrics{ display:flex; gap:10px; flex-wrap:wrap; }
    .metric{ flex:1 1 45%; background:rgba(255,255,255,0.02); padding:10px; border-radius:8px; }
    .metric .value{ font-size:20px; font-weight:700; margin-top:6px; }
    .small{ color:var(--muted); font-size:12px; }
    #alerts{ margin-top:10px; }
    .alert{ padding:8px 10px; border-radius:6px; margin-bottom:8px; color:#081221; font-weight:600; }
    .alert.warn{ background:#ffd86b; color:#3a2b00; }
    .alert.danger{ background:var(--danger); color:white; }
    .aqibox{ display:flex; align-items:center; justify-content:space-between; padding:12px; border-radius:8px; background:rgba(255,255,255,0.02); }
    .aq-level{ font-size:18px; font-weight:700; }
    canvas{ width:100% !important; height:300px !important; }
    footer{ margin-top:14px; color:var(--muted); font-size:12px; text-align:right; }
    .btn{ padding:8px 10px; background:var(--accent); color:#042428; border:none; border-radius:8px; cursor:pointer; font-weight:700; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#60a5fa);display:flex;align-items:center;justify-content:center;color:#042428;font-weight:800">ES</div>
      <div>
        <h1>EcoSphere Monitoring Kit — Dashboard</h1>
        <div class="small">Real-time air quality & hazardous gas monitoring</div>
      </div>
    </header>

    <div class="grid">
      <!-- Main column -->
      <div>
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <div>
              <div class="small">Device</div>
              <div style="font-weight:800;font-size:16px" id="deviceId">device-001</div>
            </div>
            <div style="text-align:right">
              <div class="small">Last update</div>
              <div id="lastUpdate" style="font-weight:700">--</div>
            </div>
          </div>

          <hr style="opacity:0.06;margin:12px 0">

          <div class="metrics" id="liveMetrics">
            <div class="metric">
              <div class="small">PM2.5 (µg/m³)</div>
              <div class="value" id="pm25">--</div>
            </div>
            <div class="metric">
              <div class="small">PM10 (µg/m³)</div>
              <div class="value" id="pm10">--</div>
            </div>
            <div class="metric">
              <div class="small">Temperature (°C)</div>
              <div class="value" id="temp">--</div>
            </div>
            <div class="metric">
              <div class="small">Humidity (%)</div>
              <div class="value" id="hum">--</div>
            </div>
            <div class="metric" style="flex-basis:100%">
              <div class="small">Combustible gas (raw)</div>
              <div class="value" id="gases">--</div>
            </div>
          </div>

          <div id="alerts"></div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
            <div style="font-weight:800">Trends</div>
            <div><button class="btn" id="btnFetchPred">Fetch Prediction</button></div>
          </div>
          <canvas id="chartPM"></canvas>
        </div>

        <div class="card" style="margin-top:12px;">
          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;">
            <div>
              <div class="small">AQI (derived)</div>
              <div class="aqibox">
                <div>
                  <div style="font-size:24px;font-weight:800" id="aqiValue">--</div>
                  <div class="small" id="aqiNice">--</div>
                </div>
                <div style="text-align:right">
                  <div class="small">Prediction</div>
                  <div id="mlPrediction" style="font-weight:800">--</div>
                </div>
              </div>
            </div>
            <div style="width:220px">
              <div class="small">Notes</div>
              <div style="font-size:13px;color:var(--muted)">Replace firebaseConfig with your details. Configure sensor DB path in <code>DB_PATH</code>.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right column -->
      <div>
        <div class="card">
          <div style="font-weight:800;margin-bottom:10px">Device Selector</div>
          <div class="small" style="margin-bottom:8px">Select Device ID</div>
          <select id="deviceSelect" style="width:100%;padding:8px;border-radius:6px;background:rgba(0,0,0,0.35);border:none;color:#e6eef5">
            <option>device-001</option>
            <option>device-002</option>
          </select>

          <hr style="opacity:0.06;margin:12px 0">

          <div style="font-weight:800;margin-bottom:8px">Status</div>
          <div class="small">Connection: <span id="connStatus" style="font-weight:800">—</span></div>

          <div style="margin-top:12px">
            <div style="font-weight:800">AQI Legend</div>
            <ul style="padding-left:16px;color:var(--muted);font-size:13px">
              <li>0–50 Good</li>
              <li>51–100 Moderate</li>
              <li>101–150 Unhealthy for Sensitive</li>
              <li>151–200 Unhealthy</li>
              <li>>200 Very Unhealthy / Hazardous</li>
            </ul>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:800;margin-bottom:8px">Actions</div>
          <button class="btn" id="btnTestAlert" style="width:100%;margin-bottom:8px">Test Alert</button>
          <button class="btn" id="btnClear" style="width:100%;background:#7c3aed;margin-top:6px">Clear Chart</button>
        </div>
      </div>
    </div>

    <footer>EcoSphere Monitoring Kit • Prototype Dashboard</footer>
  </div>

<script>
/* ========== CONFIG - replace with your Firebase config ========== */
const firebaseConfig = {
  apiKey: "REPLACE_ME",
  authDomain: "REPLACE_ME.firebaseapp.com",
  databaseURL: "https://REPLACE_ME-default-rtdb.firebaseio.com",
  projectId: "REPLACE_ME",
  storageBucket: "REPLACE_ME.appspot.com",
  messagingSenderId: "REPLACE_ME",
  appId: "REPLACE_ME"
};

// Set the DB path where ESP32 writes latest data for a device
let DB_PATH = "/devices/device-001/latest";

/* ================= INIT FIREBASE ================= */
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

/* ================= UI ELEMENTS ================= */
const deviceIdEl = document.getElementById('deviceId');
const lastUpdateEl = document.getElementById('lastUpdate');
const pm25El = document.getElementById('pm25');
const pm10El = document.getElementById('pm10');
const tempEl = document.getElementById('temp');
const humEl = document.getElementById('hum');
const gasesEl = document.getElementById('gases');
const alertsEl = document.getElementById('alerts');
const connStatusEl = document.getElementById('connStatus');
const deviceSelect = document.getElementById('deviceSelect');
const aqiValueEl = document.getElementById('aqiValue');
const aqiNiceEl = document.getElementById('aqiNice');
const mlPredictionEl = document.getElementById('mlPrediction');
const btnFetchPred = document.getElementById('btnFetchPred');
const btnTestAlert = document.getElementById('btnTestAlert');
const btnClear = document.getElementById('btnClear');

/* ================= CHART SETUP ================= */
const ctx = document.getElementById('chartPM').getContext('2d');
const chartData = { labels: [], datasets: [
  { label:'PM2.5 (µg/m³)', data: [], borderWidth:2, fill:false },
  { label:'PM10 (µg/m³)', data: [], borderWidth:2, fill:false }
]};
const chart = new Chart(ctx, {
  type: 'line',
  data: chartData,
  options: {
    responsive:true, maintainAspectRatio:false,
    scales:{ x:{ display:true }, y:{ beginAtZero:true } }
  }
});

/* ================= AQI helper (simplified) =================
   We'll compute a simple AQI based on PM2.5 using EPA breakpoints approximation.
   This is a basic mapping for quick user feedback; use official formula for production.
*/
function pm25ToAQI(pm25){
  // breakpoints (truncated, approximate)
  if (pm25 <= 12) return Math.round((50/12)*pm25);
  if (pm25 <= 35.4) return Math.round(50 + (50*(pm25-12))/(35.4-12));
  if (pm25 <= 55.4) return Math.round(100 + (50*(pm25-35.4))/(55.4-35.4));
  if (pm25 <= 150.4) return Math.round(150 + (50*(pm25-55.4))/(150.4-55.4));
  if (pm25 <= 250.4) return Math.round(200 + (50*(pm25-150.4))/(250.4-150.4));
  return 301 + Math.round(pm25); // very rough
}
function aqiCategory(aqi){
  if(aqi<=50) return { label: 'Good', cls:'good' };
  if(aqi<=100) return { label: 'Moderate', cls:'moderate' };
  if(aqi<=150) return { label: 'Unhealthy for Sensitive', cls:'warn' };
  if(aqi<=200) return { label: 'Unhealthy', cls:'danger' };
  return { label: 'Very Unhealthy', cls:'danger' };
}

/* ================ REALTIME LISTENER ==================== */
let dbRef = null;
function listenToDevice(path){
  if(dbRef) dbRef.off();
  dbRef = database.ref(path);
  connStatusEl.innerText = "Connecting...";
  dbRef.on('value', snapshot => {
    connStatusEl.innerText = "Connected";
    const data = snapshot.val();
    if(!data) return;
    updateDashboard(data);
  }, err => {
    connStatusEl.innerText = "Error";
    console.error("Firebase read error", err);
  });
}

/* =============== UPDATE UI ================= */
function updateDashboard(data){
  const ts = data.timestamp ? new Date(data.timestamp) : new Date();
  lastUpdateEl.innerText = ts.toLocaleString();

  // Replace with your actual keys
  const pm25 = parseFloat(data.pm25 ?? data.PM25 ?? 0);
  const pm10 = parseFloat(data.pm10 ?? data.PM10 ?? 0);
  const temp = parseFloat(data.temperature ?? data.temp ?? 0);
  const hum  = parseFloat(data.humidity ?? data.hum ?? 0);
  const gases = data.gases ?? data.mq_co ?? data.mq_lpg ?? '—';

  deviceIdEl.innerText = (DB_PATH.split('/')[2] || 'device-001');
  pm25El.innerText = isNaN(pm25) ? '--' : pm25.toFixed(1);
  pm10El.innerText = isNaN(pm10) ? '--' : pm10.toFixed(1);
  tempEl.innerText = isNaN(temp) ? '--' : temp.toFixed(1);
  humEl.innerText = isNaN(hum) ? '--' : hum.toFixed(0);
  gasesEl.innerText = gases;

  // Chart update — push timestamp label and values
  const label = ts.toLocaleTimeString();
  chart.data.labels.push(label);
  chart.data.datasets[0].data.push(isNaN(pm25)?null:pm25);
  chart.data.datasets[1].data.push(isNaN(pm10)?null:pm10);
  // limit to last 60 points
  if(chart.data.labels.length>60){
    chart.data.labels.shift();
    chart.data.datasets.forEach(ds=>ds.data.shift());
  }
  chart.update();

  // AQI
  const aqi = pm25ToAQI(isNaN(pm25)?0:pm25);
  aqiValueEl.innerText = aqi;
  const cat = aqiCategory(aqi);
  aqiNiceEl.innerText = cat.label;

  // Alerts: simple threshold rules
  alertsEl.innerHTML = '';
  if(aqi > 150){
    addAlert('Air quality is unhealthy! Consider ventilating & avoiding outdoor exposure.', 'danger');
  } else if(aqi > 100){
    addAlert('Air quality is unhealthy for sensitive groups.', 'warn');
  }
  // gas thresholds (raw example, adjust based on sensor calibration)
  if(typeof gases === 'number' && gases > 300){
    addAlert('High combustible gas reading detected — possible leak!', 'danger');
  }
}

/* ============== ALERT UTIL ============== */
function addAlert(text, level='warn'){
  const d = document.createElement('div');
  d.className = 'alert ' + (level==='danger' ? 'danger' : 'warn');
  d.innerText = text;
  alertsEl.appendChild(d);
}

/* ============== DEVICE SELECTOR ============== */
deviceSelect.addEventListener('change', (e)=>{
  const id = e.target.value;
  DB_PATH = `/devices/${id}/latest`;
  listenToDevice(DB_PATH);
});

/* ============== PREDICTION (placeholder) ============== */
async function fetchPrediction(){
  // Example: call your Cloud Function / endpoint that returns prediction for the device
  // Replace the URL below with your actual endpoint
  const endpoint = 'https://YOUR_CLOUD_FUNCTION_URL/predict?device=' + encodeURIComponent(deviceSelect.value);
  try{
    // Uncomment to call real endpoint
    // const res = await fetch(endpoint);
    // const json = await res.json();
    // mlPredictionEl.innerText = `${json.prediction} (${(json.confidence*100).toFixed(0)}%)`;

    // placeholder behavior
    mlPredictionEl.innerText = 'No model endpoint configured';
  }catch(err){
    console.error(err);
    mlPredictionEl.innerText = 'Prediction error';
  }
}
btnFetchPred.addEventListener('click', fetchPrediction);

/* ============== TEST / CONTROL =============== */
btnTestAlert.addEventListener('click', ()=> addAlert('This is a test alert — system working', 'warn'));
btnClear.addEventListener('click', ()=> {
  chart.data.labels = [];
  chart.data.datasets.forEach(ds=>ds.data=[]);
  chart.update();
});

/* ================= START ================= */
document.addEventListener('DOMContentLoaded', ()=>{
  // default device path: ensure deviceSelect default matches
  listenToDevice(DB_PATH);
  deviceIdEl.innerText = DB_PATH.split('/')[2] || 'device-001';
  connStatusEl.innerText = 'Connecting...';
});
</script>
</body>
</html>
